$(document).ready(function () {
    $(document).on('click', '.js-cart-drawer-open, .drawer__close-btn', function (e) {
        e.preventDefault();
        $('#drawer-cart-id').toggleClass('drawer--is-visible');
        if ($('#drawer-cart-id').hasClass('drawer--is-visible')) {
            $('body').css('overflow', 'hidden');
        } else {
            $('body').css('overflow', '');
        }
    });
    $(document).on('click', '.drawer__overlay', function (e) {
        $('#drawer-cart-id').removeClass('drawer--is-visible');
        $('body').css('overflow', '');
    });    
});

$(document).ready(function() {
    const loadingBar = $('<div class="loading-bar"></div>');
    $('body').append(loadingBar);
    $(document).on('click', '.qtyBtn', function(e) {
        e.preventDefault();
        const $link = $(this);
        const $qtyField = $link.closest('.qtyField');
        const $input = $qtyField.find('.qty');
        const currentQty = parseInt($input.val());
        const isPlus = $link.hasClass('plus');
        const newQty = isPlus ? currentQty + 1 : Math.max(0, currentQty - 1);
        const url = $link.attr('href').replace(/quantity=\d+/, `quantity=${newQty}`);
        
        updateCartItem($link.closest('li').find('.remove').data('id'), newQty, url);
    });

    // Remove item handler
    $(document).on('click', '.cartDrawerRemove', function(e) {
        e.preventDefault();
        const $removeBtn = $(this);
        const cartItemId = $removeBtn.data('id');
        updateCartItem(cartItemId, 0);
    });

    /*Function to handle both quantity updates and removal*/
    function updateCartItem(cartItemId, quantity, url = null) {
        
        if (!url) {
            url = `/cart/change?id=${cartItemId}&quantity=${quantity}`;
        }
        loadingBar.css('width', '0').show();
        loadingBar.animate({width: '70%'}, 300);
        $.ajax({
            url: url,
            method: 'GET',
            dataType: 'json',
            beforeSend: function() {
                 $('.qtyBtn, .cartDrawerRemove').prop('disabled', true);
            },
            success: function(response) {
                loadingBar.animate({width: '100%'}, 200, function() {
                    $(this).fadeOut(200);
                });
                if (response.success) {
                    $('.drawer__body', '#drawer-cart-id').html(response.cart_html);
                   // $('.minicart-header .cart-count').text(response.cart_count);
                    $('.countCartDisplay, .minicart-header .cart-count').text(response.cart_count);
                    feather.replace();                    
                    showNotificationAll("success", "", response.message);
                                      
                } else {
                    showNotificationAll("warning", "", response.message);
                }
            },
            error: function(xhr) {
                loadingBar.stop().animate({width: '100%'}, 200, function() {
                    $(this).fadeOut(200);
                });
                let errorMessage = 'An error occurred while updating the cart.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                 showNotificationAll("warning", "", errorMessage);
            },
            complete: function() {
                $('.qtyBtn, .cartDrawerRemove').prop('disabled', false);
            }
            
        });
    }

    
});